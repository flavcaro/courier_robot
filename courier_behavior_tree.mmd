%% Courier Robot Behavior Tree - ACTUAL IMPLEMENTATION
%% Generated from nav2_mission_controller_bt.py
%% 
%% Node Types:
%% - Selector: ? (try children in order until one succeeds)
%% - Sequence: → (execute children in order, fail if any fails)
%% - Decorator: ↻ (modifies child behavior)
%% - Condition: ◇ (check/test)
%% - Action: ▢ (do something)

flowchart TD
    Root["Mission Root<br/>→(Sequence)"]
    
    %% Phase 1: Navigate To Pickup
    RepeatPickup["Repeat Until Pickup<br/>↻(SuccessIsRunning)"]
    NavPickupRetry["Navigate To Pickup<br/>↻(Retry: 100x)"]
    MoveCell1["Move One Cell<br/>?(Selector)"]
    PathCheck1["Invert Path Check<br/>↻(SuccessIsFailure)"]
    IsComplete1["Path Complete?<br/>◇(Condition)"]
    NavOrHandle1["Nav Or Handle Obstacle<br/>?(Selector)"]
    NavSeq1["Navigate Cell<br/>→(Sequence)"]
    GetWaypoint1["Get Next Waypoint<br/>▢(Action)"]
    Rotate1["Rotate To Target<br/>▢(Action)"]
    Move1["Move To Target<br/>▢(Action)"]
    HandleObs1["Handle Obstacle<br/>▢(Backup & Replan)"]
    
    %% Phase 2: Collect
    CollectObject["Collect Object<br/>▢(4s gripper animation)"]
    
    %% Phase 3: Plan Return
    PlanReturn["Plan Return Path<br/>▢(BFS pathfinding)"]
    
    %% Phase 4: Navigate Home
    RepeatHome["Repeat Until Home<br/>↻(SuccessIsRunning)"]
    NavHomeRetry["Navigate To Home<br/>↻(Retry: 100x)"]
    MoveCell2["Move One Cell<br/>?(Selector)"]
    PathCheck2["Invert Path Check<br/>↻(SuccessIsFailure)"]
    IsComplete2["Path Complete?<br/>◇(Condition)"]
    NavOrHandle2["Nav Or Handle Obstacle<br/>?(Selector)"]
    NavSeq2["Navigate Cell<br/>→(Sequence)"]
    GetWaypoint2["Get Next Waypoint<br/>▢(Action)"]
    Rotate2["Rotate To Target<br/>▢(Action)"]
    Move2["Move To Target<br/>▢(Action)"]
    HandleObs2["Handle Obstacle<br/>▢(Backup & Replan)"]
    
    %% Phase 5: Deliver
    Deliver["Deliver Object<br/>▢(4s gripper animation)"]
    
    %% Main sequence connections
    Root --> RepeatPickup
    Root --> CollectObject
    Root --> PlanReturn
    Root --> RepeatHome
    Root --> Deliver
    
    %% Navigate to Pickup structure
    RepeatPickup --> NavPickupRetry
    NavPickupRetry --> MoveCell1
    MoveCell1 --> PathCheck1
    MoveCell1 --> NavOrHandle1
    PathCheck1 --> IsComplete1
    NavOrHandle1 --> NavSeq1
    NavOrHandle1 --> HandleObs1
    NavSeq1 --> GetWaypoint1
    NavSeq1 --> Rotate1
    NavSeq1 --> Move1
    
    %% Navigate to Home structure
    RepeatHome --> NavHomeRetry
    NavHomeRetry --> MoveCell2
    MoveCell2 --> PathCheck2
    MoveCell2 --> NavOrHandle2
    PathCheck2 --> IsComplete2
    NavOrHandle2 --> NavSeq2
    NavOrHandle2 --> HandleObs2
    NavSeq2 --> GetWaypoint2
    NavSeq2 --> Rotate2
    NavSeq2 --> Move2
    NavSeq2 --> Rotate2
    NavSeq2 --> Move2
    
    %% Styling
    classDef selector fill:#FF9999,stroke:#CC0000,stroke-width:3px,color:#000
    classDef sequence fill:#99CCFF,stroke:#0066CC,stroke-width:3px,color:#000
    classDef decorator fill:#FFD699,stroke:#FF8C00,stroke-width:3px,color:#000
    classDef condition fill:#99DD99,stroke:#228B22,stroke-width:2px,color:#000
    classDef action fill:#CC99FF,stroke:#6600CC,stroke-width:2px,color:#000
    
    class MoveCell1,MoveCell2,NavOrHandle1,NavOrHandle2 selector
    class Root,NavSeq1,NavSeq2 sequence
    class RepeatPickup,RepeatHome,NavPickupRetry,NavHomeRetry,PathCheck1,PathCheck2 decorator
    class IsComplete1,IsComplete2 condition
    class GetWaypoint1,Rotate1,Move1,HandleObs1,CollectObject,PlanReturn,GetWaypoint2,Rotate2,Move2,HandleObs2,Deliver action
